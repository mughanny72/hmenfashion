<!doctype html>
<html>
<head><meta charset="utf-8"><title>Success</title></head>
<body style="font-family:Arial;padding:30px">
  <h1>✅ Payment Successful</h1>
  <p>Thank you! Your subscription is active.</p>

  <p id="msg">Loading...</p>
  <p id="sid"></p>

  <button id="go" style="display:none;padding:10px 16px;margin-right:10px">Go to Member Area</button>
  <button id="logout" style="display:none;padding:10px 16px">Logout</button>

  <script>
    const p = new URLSearchParams(location.search);
    const sid = p.get("session_id");
    document.getElementById("sid").textContent = sid ? ("Session: " + sid) : "";

    async function run(){
      if(!sid){
        document.getElementById("msg").textContent = "Missing session_id.";
        return;
      }

      try{
        const r = await fetch("/api/get-session-email?session_id=" + encodeURIComponent(sid));
        const j = await r.json();

        if(!j.ok || !j.email){
          document.getElementById("msg").textContent =
            "Email not found. Please go back and enter your email before checkout.";
          return;
        }

        // ✅ this is the only thing your member page needs
        localStorage.setItem("userEmail", String(j.email).trim().toLowerCase());

        document.getElementById("msg").textContent =
          "Saved email: " + j.email + " ✅";

        document.getElementById("go").style.display = "inline-block";
        document.getElementById("logout").style.display = "inline-block";
      }catch(e){
        document.getElementById("msg").textContent = "Server error.";
      }
    }

    document.getElementById("go").onclick = () => location.href = "/app.html"; // change to your member page
    document.getElementById("logout").onclick = () => {
      localStorage.removeItem("userEmail");
      location.href = "/index.html";
    };

    run();
  </script>
</body>
</html>